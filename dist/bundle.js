(()=>{let e=[],t=[],n="claude-3-opus-20240229";const o=document.getElementById("note-input"),s=document.getElementById("note-text"),a=document.getElementById("note-tags"),c=document.getElementById("save-note"),i=document.getElementById("search-input"),l=document.getElementById("tag-select"),d=document.getElementById("notes-container"),r=document.getElementById("toggle-batch-edit"),m=(document.getElementById("batch-edit-toolbox"),document.getElementById("delete-selected-notes")),u=document.getElementById("selected-notes-tags"),y=document.getElementById("update-selected-notes-tags");document.addEventListener("DOMContentLoaded",(()=>{async function g(){try{R();const t=await fetch("/api/notes");if(t.ok){const n=await t.json();n.success?(e=n.notes,B(),A()):console.error("Error fetching notes:",n.error)}else console.error("Error fetching notes")}catch(e){console.error("Error fetching notes:",e)}finally{G()}}g();const p=document.createElement("div");p.textContent="Please enter your Anthropic API key to enable AI functions.",p.style.backgroundColor="rgba(0, 0, 0, 0.8)",p.style.color="white",p.style.padding="20px",p.style.position="fixed",p.style.top="50%",p.style.left="50%",p.style.transform="translate(-50%, -50%)",p.style.zIndex="9999",p.style.display="none";const h=document.createElement("button");function E(){p.style.display="block"}function f(){p.style.display="none"}h.textContent="Close",h.addEventListener("click",(()=>{p.style.display="none"})),p.appendChild(h),document.body.appendChild(p);const v=document.getElementById("api-key-container"),L=document.getElementById("set-api-key"),k=document.createElement("input");k.type="password",k.placeholder="Enter Anthropic API key",k.style.display="none",k.style.margin="0px 10px",v.appendChild(k);const w=document.createElement("button");w.textContent="Save API Key",w.style.display="none",w.addEventListener("click",(async function(){const e=k.value.trim();if(e)try{(await fetch("/api/saveApiKey",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:e})})).ok?(k.style.display="none",w.style.display="none",L.textContent="Update API Key",f()):(E(),console.error("Error saving API key"))}catch(e){console.error("Error saving API key:",e)}})),v.appendChild(w);const I=document.createElement("input");I.type="password",I.placeholder="Enter updated Anthropic API key",I.style.display="none",v.appendChild(I);const x=document.createElement("button");x.textContent="Update API Key",x.style.display="none",x.addEventListener("click",(async function(){const e=I.value.trim();if(e)try{(await fetch("/api/updateApiKey",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:e})})).ok?(I.style.display="none",x.style.display="none"):console.error("Error updating API key")}catch(e){console.error("Error updating API key:",e)}})),v.appendChild(x),L.addEventListener("click",(async()=>{try{const e=await fetch("/api/checkApiKey");if(e.ok){const{hasApiKey:t}=await e.json();t?"block"==I.style.display?(I.style.display="none",x.style.display="none"):(I.style.display="block",x.style.display="block"):"block"==k.style.display?(k.style.display="none",w.style.display="none"):(k.style.display="block",w.style.display="block"),"Update API Key"==L.textContent||"Set API Key"==L.textContent?L.textContent="Return":L.textContent="Update API Key",f()}else E(),console.error("Error checking API key")}catch(e){console.error("Error checking API key:",e)}})),window.addEventListener("load",(async function(){try{const e=await fetch("/api/checkApiKey");if(e.ok){const{hasApiKey:t}=await e.json();t?(L.textContent="Update API Key",f()):E()}}catch(e){console.error("Error checking API key on load:",e)}}));const b=document.createElement("div");function B(n=!1){const o=function(){const t=i.value.toLowerCase(),n=Array.from(l.selectedOptions).map((e=>e.value));return e.filter((e=>e.text.toLowerCase().includes(t)&&(0===n.length||n.every((t=>e.tags.includes(t))))))}(),s=document.getElementById("prioritize-selected-notes").checked,a=t.map((e=>e._id)),c=s?[...t,...o.filter((e=>!a.includes(e._id)))]:o;d.innerHTML="",c.forEach((e=>{const o=document.createElement("div");o.classList.add("note"),o.style.opacity=0,o.style.transform="translateY(20px)",o.addEventListener("click",(n=>{if(!o.classList.contains("editing")){n.stopPropagation();const s=t.findIndex((t=>t._id===e._id));-1!==s?(t.splice(s,1),o.classList.remove("selected")):(t.push(e),o.classList.add("selected")),B()}})),a.includes(e._id)?o.classList.add("selected"):o.classList.remove("selected");const s=document.createElement("div");s.classList.add("note-text"),s.innerHTML=function(e,t){const n=new RegExp(t,"gi");return e.replace(n,'<span class="highlight">$&</span>')}(e.text,i.value),s.textContent=e.text,o.appendChild(s);const c=document.createElement("div");var l,r;c.classList.add("note-tags"),c.textContent=e.tags.join(", "),c.innerHTML=(l=e.tags,r=i.value,l.map((e=>{const t=new RegExp(r,"gi");return e.replace(t,'<span class="highlight">$&</span>')})).join(", ")),o.appendChild(c);const m=document.createElement("div");m.classList.add("note-actions");const u=document.createElement("button");u.textContent="Edit",u.addEventListener("click",(t=>{t.stopPropagation(),function(e,t,n,o,s){n.setAttribute("contenteditable","true"),o.setAttribute("contenteditable","true"),n.focus(),s.textContent="Save";const a={clickOutsideHandler:c=>{t.contains(c.target)||c.target===s||(Z(e,t,n,o,s,a),B())},keydownHandler:c=>{(c.ctrlKey||c.metaKey)&&"Enter"===c.key&&(c.preventDefault(),Z(e,t,n,o,s,a))},saveButtonHandler:()=>{Z(e,t,n,o,s,a)}};t.classList.add("editing"),t.classList.remove("selected"),document.addEventListener("click",a.clickOutsideHandler),t.addEventListener("keydown",a.keydownHandler),s.addEventListener("click",a.saveButtonHandler)}(e._id,o,s,c,u)})),m.appendChild(u);const y=document.createElement("button");y.textContent="Delete",y.addEventListener("click",(t=>{t.stopPropagation(),S(e._id)})),m.appendChild(y),o.appendChild(m),d.appendChild(o),n?setTimeout((()=>{o.classList.add("show")}),100):o.classList.add("show")})),function(){const e=document.getElementById("summarize-notes"),n=document.getElementById("surface-insights");t.length>0?(e.disabled=!1,n.disabled=!1):(e.disabled=!0,n.disabled=!0)}(),t.length>1?r.classList.remove("hidden"):(r.classList.add("hidden"),re.classList.remove("open"),r.classList.remove("open"))}function A(){const t=[...new Set(e.flatMap((e=>e.tags)))];l.innerHTML="",t.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,l.appendChild(t)}))}async function C(){const e=o.getAttribute("data-note-id"),n=s.value.trim();let c=a.value.trim().split(",").map((e=>e.trim()));if(T){const e=await async function(e){if(!T)return[];try{R();const t=[{role:"user",content:`Please generate relevant tags for the following note. Provide only a comma-separated list of tags without any additional text or formatting.\n\n        Note:\n        ${e}\n        \n        Tags:`}];return(await j("claude-3-haiku-20240307",t,1024)).content[0].text.trim().split(",").map((e=>e.trim()))}catch(e){return X("Error auto-tagging note: "+e.message),[]}finally{G()}}(n);c=c.length>1?[...c,...e]:[...e]}if(""!==n){if(e){P(e,n,c);const o=document.querySelector(`.note[data-note-id="${e}"]`);o.classList.contains("selected")?(o.classList.add("selected"),t.includes(note)||t.push(note)):(o.classList.remove("selected"),t=t.filter((e=>e._id!==note._id)))}else!async function(e,t){try{const n=await fetch("/api/notes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,tags:t,createdAt:(new Date).toISOString()})});if(n.ok){const e=await n.json();e.success?(console.log("Note created successfully"),g(),A()):console.error("Error creating note:",e.error)}else console.error("Error creating note")}catch(e){console.error("Error creating note:",e)}}(n,c);s.value="",a.value="",A(),B(),o.removeAttribute("data-note-id")}}async function P(e,t,n){try{const o=await fetch(`/api/notes/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t,tags:n,updatedAt:(new Date).toISOString()})});if(o.ok){const e=await o.json();e.success?(console.log("Note updated successfully"),g(),A()):console.error("Error updating note:",e.error)}else console.error("Error updating note")}catch(e){console.error("Error updating note:",e)}}async function S(e){if(confirm("Are you sure you want to delete this note?"))try{const t=await fetch(`/api/notes/${e}`,{method:"DELETE"});if(t.ok){const e=await t.json();e.success?(console.log("Note deleted successfully"),g(),A()):console.error("Error deleting note:",e.error)}else console.error("Error deleting note")}catch(e){console.error("Error deleting note:",e)}}b.textContent="Error: Invalid Anthropic API key. Please enter a valid API key.",b.style.color="red",b.style.display="none",document.body.appendChild(b),document.addEventListener("keydown",(e=>{if(e.ctrlKey||e.metaKey)switch(e.key){case"n":e.preventDefault(),document.activeElement===s?C():(ie.classList.toggle("open"),me(),s.focus());break;case"f":e.preventDefault(),le.classList.toggle("open"),me();break;case"s":e.preventDefault(),de.classList.toggle("open"),me();break;case"b":e.preventDefault(),re.classList.toggle("open"),me()}})),c.addEventListener("click",C),document.getElementById("prioritize-selected-notes").addEventListener("change",(()=>{B()})),i.addEventListener("input",B);const $=document.getElementById("auto-tag-setting");let T=!1;async function j(e,t,n){try{const o={model:e,messages:t,max_tokens:n},s=await fetch("/api/anthropic",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(401===s.status)throw b.style.display="block",I.style.display="block",x.style.display="block",new Error("Invalid Anthropic API key");if(!s.ok)throw new Error(`API request failed with status ${s.status}`);return await s.json()}catch(e){throw console.error("Error calling Anthropic API:",e),e}}$.addEventListener("change",(()=>{T=$.checked}));const K=document.getElementById("chat-messages"),D=document.getElementById("chat-input"),H=document.getElementById("send-question"),N=document.getElementById("reset-chat");let O=[];function _(e,t){const n=document.createElement("div");n.classList.add("chat-message",`${e}-message`),n.textContent=t,K.appendChild(n),K.scrollTop=K.scrollHeight}async function q(){const e=D.value.trim();if(""!==e){D.value="",_("user",e);try{R();const o=t.map((e=>`Note: ${e.text}\nTags: ${e.tags.join(", ")}`)).join("\n\n"),s=[{role:"user",content:`${t.length>0?`Based on the following notes:\n\n${o}\n\n`:""}Question: ${e}\n\nAnswer:`}],a=await async function(e){return(await j(n,e,1024)).content[0].text.trim()}(s);_("assistant",a),O.push({user:e,assistant:a})}catch(e){X("Error sending message: "+e.message)}finally{G()}}}D.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),q())})),H.addEventListener("click",q),N.addEventListener("click",(function(){K.innerHTML="",O=[],D.value=""}));const M=document.getElementById("summarize-notes"),U=document.getElementById("surface-insights"),z=document.getElementById("insights-output");M.addEventListener("click",(async()=>{const{summary:e,timestamp:o}=await async function(){if(0!==t.length)try{R();const e=t.map((e=>`Note: ${e.text}\nTags: ${e.tags.join(", ")}`)).join("\n\n"),o=[{role:"user",content:`Please provide a ${document.getElementById("summary-length").value} summary of the following notes. Include only the summary without any additional text or formatting.\n\n        Notes:\n        ${e}\n        \n        Summary:`}],s=(await j(n,o,1024)).content[0].text.trim(),a=(new Date).toLocaleString();return{summary:`${s}\nGenerated at: ${a}`,timestamp:a}}catch(e){return X("Error summarizing notes: "+e.message),{summary:"",timestamp:""}}finally{G()}else X("Please select notes first.")}();z.innerHTML=`\n    <h4>Summary:</h4>\n    <p>${e}</p>\n    <p>Generated at: ${o}</p>\n  `})),U.addEventListener("click",(async()=>{const{insights:e,timestamp:o}=await async function(){if(0!==t.length)try{R();const e=t.map((e=>`Note: ${e.text}\nTags: ${e.tags.join(", ")}`)).join("\n\n"),o=[{role:"user",content:`Please provide ${document.getElementById("insights-type").value} based on the following notes. Include only the insights without any additional text or formatting.\n\n        Notes:\n        ${e}\n        \n        Insights:`}],s=(await j(n,o,1024)).content[0].text.trim(),a=(new Date).toLocaleString();return{insights:`${s}\nGenerated at: ${a}`,timestamp:a}}catch(e){return X("Error surfacing insights: "+e.message),{insights:"",timestamp:""}}finally{G()}else X("Please select notes first.")}();z.innerHTML=`\n    <h4>Insights:</h4>\n    <p>${e}</p>\n    <p>Generated at: ${o}</p>\n  `})),document.getElementById("select-all-notes").addEventListener("click",(()=>{confirm("Are you sure you want to select all notes?")&&(t=[...e],B())}));const J=document.getElementById("model-select");function R(){document.getElementById("loading-spinner").classList.remove("hidden")}function G(){document.getElementById("loading-spinner").classList.add("hidden")}function X(e){const t=document.getElementById("error-message");t.textContent=e,t.classList.remove("hidden"),setTimeout((()=>{t.classList.add("hidden")}),3e3)}J.addEventListener("change",(()=>{n=J.value})),document.getElementById("deselect-all-tags").addEventListener("click",(()=>{l.selectedIndex=-1,B()}));const F=document.getElementById("save-summary"),Q=document.getElementById("export-summary"),Y=document.getElementById("save-insights"),V=document.getElementById("export-insights");F.addEventListener("click",(()=>{})),Q.addEventListener("click",(()=>{})),Y.addEventListener("click",(()=>{})),V.addEventListener("click",(()=>{})),F.addEventListener("click",(()=>{alert("No summary available to save.")})),Q.addEventListener("click",(()=>{alert("No summary available to export.")})),Y.addEventListener("click",(()=>{alert("No insights available to save.")})),V.addEventListener("click",(()=>{alert("No insights available to export.")}));const W=document.getElementById("sort-select");function Z(e,t,n,o,s,a){n.removeAttribute("contenteditable"),o.removeAttribute("contenteditable"),P(e,n.textContent.trim(),o.textContent.trim().split(",").map((e=>e.trim()))),s.textContent="Edit",t.classList.remove("editing"),document.removeEventListener("click",a.clickOutsideHandler),t.removeEventListener("keydown",a.keydownHandler),s.removeEventListener("click",a.saveButtonHandler)}W.addEventListener("change",(()=>{!function(t){switch(t){case"date-desc":e.sort(((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)));break;case"date-asc":e.sort(((e,t)=>new Date(e.createdAt)-new Date(t.createdAt)));break;case"title-asc":e.sort(((e,t)=>e.text.localeCompare(t.text)));break;case"title-desc":e.sort(((e,t)=>t.text.localeCompare(e.text)));break;case"last-edited":e.sort(((e,t)=>new Date(t.lastEdited)-new Date(e.lastEdited)))}B()}(W.value),B()})),document.getElementById("toggle-dark-mode").addEventListener("click",(function(){document.body.classList.toggle("dark-mode")}));const ee=document.getElementById("toggle-flyout"),te=document.getElementById("flyout-panel"),ne=document.getElementById("toggle-chat"),oe=document.getElementById("chat-window");ne.addEventListener("click",(()=>{if(oe.classList.toggle("open"),oe.classList.contains("open")){const e=document.createElement("div");e.classList.add("info-text"),e.textContent="Select notes in the Flyout to query those notes with the LLM.",K.prepend(e)}else{const e=K.querySelector(".info-text");e&&e.remove()}})),ee.addEventListener("click",(function(){te.classList.toggle("open"),function(){const e=document.getElementById("chat-widget"),t=document.getElementById("toggle-chat"),n=document.querySelectorAll("footer")[0],o=document.getElementById("notes-view"),s=document.querySelectorAll(".toolbox");te.classList.contains("open")?(e.style.right="calc(30vw + 60px)",t.style.transform="TranslateX(calc(-30vw - 40px))",s.forEach((e=>{e.style.width="calc(70vw - 81px)",e.style.borderRight="1px solid var(--secondary-color)"})),o.style.width="calc(70vw - 80px)",n.style.width="calc(70vw - 80px)"):(e.style.right="20px",t.style.transform="TranslateX(0)",s.forEach((e=>{e.style.width="",e.style.borderRight=""})),o.style.width="",n.style.width="")}()})),document.getElementById("logout-button").addEventListener("click",(()=>{!async function(){try{const e=await fetch("/api/logout",{method:"POST"});if(e.ok){const t=await e.json();t.success?(console.log("User logged out successfully"),window.location.href="/landing.html"):console.error("Error logging out:",t.error)}else console.error("Error logging out")}catch(e){console.error("Error logging out:",e)}}()}));const se=document.querySelectorAll(".toolbox-tab"),ae=document.querySelectorAll(".toolbox-tab-content");function ce(t,n){const o=e.find((e=>e._id===t));if(o){const e=[...new Set(n)];o.tags=e,P(t,o.text,e)}}se.forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-tab");se.forEach((e=>e.classList.remove("active"))),ae.forEach((e=>e.classList.add("hidden"))),e.classList.add("active"),document.getElementById(t+"-tab").classList.remove("hidden")}))})),document.getElementById("toolbox"),document.getElementById("deselect-all-notes").addEventListener("click",(()=>{t=[],B()})),l.addEventListener("change",(()=>{const e=Array.from(l.selectedOptions);if(1===e.length){const t=e[0].value;l.value!==t&&(l.selectedIndex=-1)}B()})),m.addEventListener("click",(()=>{t.length>0&&confirm("Are you sure you want to delete the selected notes?")&&(t.forEach((e=>S(e._id))),t=[],B())})),y.addEventListener("click",(()=>{if(t.length>0){const e=u.value.trim().split(",").map((e=>e.trim())).filter((e=>""!==e));t.forEach((t=>{""==t.tags?ce(t._id,e):ce(t._id,t.tags.concat(e))})),u.value="",B()}}));const ie=document.getElementById("add-note-toolbox"),le=document.getElementById("search-sort-toolbox"),de=document.getElementById("select-notes-toolbox"),re=document.getElementById("batch-edit-toolbox");function me(){const e=document.getElementById("notes-view"),t=document.querySelectorAll(".toolbox");let n=0;t.forEach((e=>{e.classList.contains("open")&&(n+=e.offsetHeight)})),e.style.height=`calc(100vh - ${140+n}px)`}function ue(){document.querySelectorAll(".toolbox").forEach((e=>{e.classList.remove("open"),e.style.display=""}))}document.getElementById("toggle-add-note").addEventListener("click",(()=>{ie.classList.contains("open")?(ie.classList.remove("open"),ie.style.display=""):(ue(),ie.classList.add("open"),ie.style.display="flex",s.focus()),me()})),document.getElementById("toggle-search-sort").addEventListener("click",(()=>{le.classList.contains("open")?le.classList.remove("open"):(ue(),le.classList.toggle("open")),me()})),document.getElementById("toggle-select-notes").addEventListener("click",(()=>{de.classList.contains("open")?de.classList.remove("open"):(ue(),de.classList.toggle("open")),me()})),document.getElementById("toggle-batch-edit").addEventListener("click",(()=>{re.classList.contains("open")?re.classList.remove("open"):(ue(),re.classList.toggle("open")),me()})),s.addEventListener("keydown",(e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),C())}))}))})();